<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management - Table View</title>
    <link rel="stylesheet" href="/css/table-style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Virspacio Ticket Management</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshTable()">Refresh</button>
                <button class="btn btn-success" onclick="bulkAction()">Bulk Action</button>
                <button class="btn btn-info" onclick="openUserManagement()" style="margin-left: 10px;">
                    Manage Users
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Sidebar Checklist -->
            <aside class="checklist-sidebar">
                <div class="sidebar-header">
                    <h3>Filters & Selection</h3>
                </div>

                <div class="quick-actions">
                    <h4>Quick Actions</h4>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="location.href='/dashboard'">
                            Dashboard
                        </button>
                        <button class="btn btn-success" onclick="location.href='/?create=new'">
                            Create New Ticket
                        </button>
                        <button class="btn btn-outline" onclick="exportToCSV()">
                            Export to CSV
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <h4>Selected Tickets (<span id="selected-count">0</span>)</h4>
                    <button class="btn btn-small" onclick="selectAll()">Select All</button>
                    <button class="btn btn-small" onclick="clearSelection()">Clear</button>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <h4>Status</h4>
                    <label class="checkbox-item">
                        <input type="checkbox" value="OPEN" checked onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Open
                        <span class="count-badge" id="count-OPEN">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="IN_PROGRESS" checked onchange="updateFilters()">
                        <span class="checkmark"></span>
                        In Progress
                        <span class="count-badge" id="count-IN_PROGRESS">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="RESOLVED" onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Resolved
                        <span class="count-badge" id="count-RESOLVED">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="CLOSED" onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Closed
                        <span class="count-badge" id="count-CLOSED">0</span>
                    </label>
                </div>

                <!-- Quick Stats -->
                <div class="stats-group">
                    <h4>Quick Stats</h4>
                    <div class="stat-item">
                        <span>Total Tickets:</span>
                        <strong id="stat-total">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Open:</span>
                        <strong id="stat-open">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Due Today:</span>
                        <strong id="stat-due-today">0</strong>
                    </div>
                </div>
            </aside>

            <!-- Main Table Area -->
            <main class="table-container">
                <!-- Table Controls -->
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search tickets..." 
                               onkeyup="debouncedSearch()">
                        <span class="search-icon">⌕</span>
                    </div>
                    
                    <div class="view-options">
                        <select id="sort-select" onchange="updateSorting()">
                            <option value="createdAt,desc">Newest First</option>
                            <option value="createdAt,asc">Oldest First</option>
                            <option value="priority,desc">Priority (High to Low)</option>
                            <option value="priority,asc">Priority (Low to High)</option>
                            <option value="title,asc">Title (A-Z)</option>
                        </select>
                        
                        <select id="page-size" onchange="changePageSize()">
                            <option value="10">10 per page</option>
                            <option value="25" selected>25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="auto-refresh-toggle" checked>
                            <span class="toggle-slider"></span>
                            Live Updates
                        </label>
                        <span id="refresh-indicator" class="refresh-indicator"> Live</span>
                    </div>
                </div>

                <!-- Tickets Table -->
                <div class="table-wrapper">
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                <th class="select-column">
                                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                                </th>
                                <th class="id-column">ID</th>
                                <th class="title-column">Title</th>
                                <th class="status-column">Status</th>
                                <th class="priority-column">Priority</th>
                                <th class="assignee-column">Assignee</th>
                                <th class="requester-column">Requester</th>
                                <th class="date-column">Created</th>
                                <th class="actions-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="loading-state hidden">
                    <div class="loading-spinner"></div>
                    <span>Loading tickets...</span>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state hidden">
                    <p>No tickets found matching your criteria.</p>
                    <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing <span id="page-start">0</span> to <span id="page-end">0</span> 
                        of <span id="total-items">0</span> tickets
                    </div>
                    
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="first-page" onclick="goToPage(1)" disabled>
                            « First
                        </button>
                        <button class="pagination-btn" id="prev-page" onclick="previousPage()" disabled>
                            ‹ Previous
                        </button>
                        
                        <div class="page-numbers" id="page-numbers">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        
                        <button class="pagination-btn" id="next-page" onclick="nextPage()" disabled>
                            Next ›
                        </button>
                        <button class="pagination-btn" id="last-page" onclick="goToPage(1)" disabled>
                            Last »
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Ticket Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Ticket</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label class="required">Subject</label>
                        <input type="text" class="form-input" id="edit-subject" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Status</label>
                        <select class="form-select" id="edit-status" required>
                            <option value="OPEN">Open</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="RESOLVED">Resolved</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Priority</label>
                        <select class="form-select" id="edit-priority" required>
                            <option value="LOW">Low</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Assigned To</label>
                        <select class="form-select" id="edit-assignedPerson" required>
                            <option value="">Select IT Staff</option>
                            <!-- IT staff will be populated dynamically -->
                        </select>
                    </div>
                    
                    <!-- Original Description (Read-only) -->
                    <div class="form-group">
                        <label>Original Description</label>
                        <div class="readonly-description" id="edit-original-description" style="
                            background: #f8f9fa;
                            padding: 12px;
                            border-radius: 4px;
                            border: 1px solid #e9ecef;
                            min-height: 80px;
                            max-height: 150px;
                            overflow-y: auto;
                            font-size: 0.9em;
                            color: #495057;
                        "></div>
                    </div>
                    
                    <!-- IT Comments Section -->
                    <div class="form-group">
                        <label>IT Comments & Updates</label>
                        <textarea class="form-textarea" id="edit-it-comment" placeholder="Add IT comments, updates, or resolution details here..." style="min-height: 100px;"></textarea>
                        <small style="color: #666; display: block; margin-top: 4px;">
                            This field is for IT staff comments only. The original description cannot be modified.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTicketEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- View Ticket Modal - Updated with Timestamps -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ticket Details</h2>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="ticket-details">
                    <div class="detail-row">
                        <label>Ticket ID:</label>
                        <span id="view-id"></span>
                    </div>
                    <div class="detail-row">
                        <label>Subject:</label>
                        <span id="view-subject"></span>
                    </div>
                    <div class="detail-row">
                        <label>Requester:</label>
                        <span id="view-requester"></span>
                    </div>
                    <div class="detail-row">
                        <label>Status:</label>
                        <span id="view-status"></span>
                    </div>
                    <div class="detail-row">
                        <label>Priority:</label>
                        <span id="view-priority"></span>
                    </div>
                    <div class="detail-row">
                        <label>Assigned To:</label>
                        <span id="view-assigned"></span>
                    </div>
                    
                    <!-- Timestamps Section -->
                    <div class="detail-row full-width">
                        <label>Timestamps:</label>
                        <div class="timestamps-section">
                            <div class="timestamp-item">
                                <span class="timestamp-label">Created:</span>
                                <span id="view-created">Unknown</span>
                            </div>
                            <div class="timestamp-item">
                                <span class="timestamp-label">Last Updated:</span>
                                <span id="view-updated">Unknown</span>
                            </div>
                            <div class="timestamp-item">
                                <span class="timestamp-label">Opened:</span>
                                <span id="view-opened-time">Unknown</span>
                            </div>
                            <div class="timestamp-item">
                                <span class="timestamp-label">Closed:</span>
                                <span id="view-closed-time">Not closed yet</span>
                            </div>
                            <div class="timestamp-item" id="view-resolution-time-container" style="display: none;">
                                <span class="timestamp-label">Time to Resolve:</span>
                                <span id="view-resolution-time">N/A</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Information Section -->
                    <div class="detail-row full-width">
                        <label>Network Information:</label>
                        <div class="network-info-section">
                            <div class="network-info-item">
                                <span class="network-info-label">IP Address:</span>
                                <span id="view-ip">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Computer Name:</span>
                                <span id="view-computer">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">User Agent:</span>
                                <span id="view-useragent">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Private IP:</span>
                                <span id="view-private-ip">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Username:</span>
                                <span id="view-username">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Device ID:</span>
                                <span id="view-device-id">Unknown</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Original Description -->
                    <div class="detail-row full-width">
                        <label>Original Description:</label>
                        <div id="view-description" class="description-content"></div>
                    </div>
                    
                    <!-- IT Comments Section -->
                    <div class="detail-row full-width">
                        <label>IT Comments & Updates:</label>
                        <div id="view-it-comment" class="description-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bulk Actions</h2>
                <span class="close" onclick="closeBulkModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Action</label>
                    <select class="form-select" id="bulk-action">
                        <option value="">Select Action</option>
                        <option value="assign">Assign Tickets</option>
                        <option value="change-status">Change Status</option>
                        <option value="change-priority">Change Priority</option>
                        <option value="close">Close Tickets</option>
                        <option value="delete">Delete Tickets</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-assign-field" style="display: none;">
                    <label>Assign To</label>
                    <select class="form-select" id="bulk-assignee">
                        <option value="">Select IT Staff</option>
                        <!-- IT staff will be populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group" id="bulk-status-field" style="display: none;">
                    <label>New Status</label>
                    <select class="form-select" id="bulk-status">
                        <option value="OPEN">Open</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-priority-field" style="display: none;">
                    <label>New Priority</label>
                    <select class="form-select" id="bulk-priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                
                <div class="selected-info">
                    <p>This action will affect <strong id="bulk-count">0</strong> selected tickets.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply Action</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-confirm-message">Are you sure you want to delete this ticket? This action cannot be undone.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">Delete Ticket</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="notification-header">
                <h2 id="notification-title">Notification</h2>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="notification-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeNotificationModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>User Management</h2>
                <span class="close" onclick="closeUserManagement()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- User Management Controls -->
                <div class="user-management-controls">
                    <div class="search-box">
                        <input type="text" id="userSearchInput" placeholder="Search users...">
                        <span class="search-icon">⌕</span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            + Add New User
                        </button>
                        <button class="btn btn-outline" onclick="exportUsersToCSV()">
                            Export CSV
                        </button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserManagement()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" class="form-input" id="userFullName" required>
                    </div>

                    <div class="form-group">
                        <label class="required">Email</label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>

                    <div class="form-group">
                        <label>Position</label>
                        <div class="searchable-dropdown">
                            <input type="text" class="form-input" id="userPositionSearch" 
                                   placeholder="Search or select position..." 
                                   oninput="filterPositions()"
                                   onfocus="showPositionDropdown()">
                            <div id="positionDropdown" class="dropdown-list hidden">
                                <!-- Positions will be populated here -->
                            </div>
                        </div>
                        <input type="hidden" id="userPosition" value="">
                    </div>

                    <div class="form-group">
                        <label class="required">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="USER">User</option>
                            <option value="ADMIN">Admin</option>
                            <option value="SUPER_ADMIN">Super Admin</option>
                        </select>
                    </div>

                    <div class="form-group" id="userPasswordGroup">
                        <label class="required">Password</label>
                        <input type="password" class="form-input" id="userPassword" 
                               placeholder="Enter password for new user">
                        <small style="color: #666;">
                            Password is required for new users. Leave blank when editing if you don't want to change it.
                        </small>
                    </div>

                    <!-- Admin-specific fields -->
                    <div id="adminFields" style="display: none;">
                        <div class="form-section">
                            <h3 class="form-section-title">Admin Settings</h3>
                            <div class="form-group">
                                <label>Admin Notes</label>
                                <textarea class="form-textarea" id="adminNotes" 
                                          placeholder="Additional notes for admin users..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Loading State -->
                <div id="userLoading" class="create-loading hidden">
                    <div class="loading-spinner"></div>
                    <p>Saving user...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="userSubmitBtn" onclick="saveUser()">
                    Add User
                </button>
            </div>
        </div>
    </div>

    <!-- Password Update Modal -->
    <div id="passwordUpdateModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Update User Password</h2>
                <span class="close" onclick="closePasswordUpdateModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>User:</label>
                    <div class="user-info" id="password-update-user-name" style="
                        background: #f8f9fa;
                        padding: 10px;
                        border-radius: 4px;
                        border: 1px solid #e9ecef;
                        font-weight: bold;
                    "></div>
                </div>
                
                <div class="form-group">
                    <label class="required">New Password</label>
                    <input type="password" class="form-input" id="newPassword" 
                           placeholder="Enter new password" required
                           minlength="6">
                    <small style="color: #666;">
                        Password must be at least 6 characters long
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="required">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" 
                           placeholder="Confirm new password" required
                           minlength="6">
                </div>
                
                <div class="security-notice" style="
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 4px;
                    padding: 12px;
                    margin: 15px 0;
                    color: #856404;
                ">
                    <strong>Security Notice:</strong> Only Super Administrators can update user passwords. 
                    This action will immediately change the user's password.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePasswordUpdateModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-warning" onclick="updateUserPassword()">
                    Update Password
                </button>
            </div>
        </div>
    </div>

    <!-- Network Info Label (for forms) -->
    <div id="network-info-label" style="margin: 10px 0;"></div>

    <!-- JavaScript Modules -->
    <script src="/js/table-manager.js"></script>

    <!-- Add CSS for the dropdown and password update -->
    <style>
        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
        }

        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item.no-results {
            color: #6c757d;
            font-style: italic;
            cursor: default;
        }

        .dropdown-item.no-results:hover {
            background-color: white;
        }

        .hidden {
            display: none;
        }

        /* Ensure the input has proper z-index */
        #userPositionSearch {
            position: relative;
            z-index: 1001;
        }

        /* Password Update Button Styles */
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: 1px solid #ffc107;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
        }

        .btn-warning:disabled {
            background-color: #ffc107;
            opacity: 0.65;
        }

        /* Icon for password button */
        .icon-lock {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 4px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23212529'%3E%3Cpath d='M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM15.1 8H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Security notice styling */
        .security-notice {
            font-size: 0.9em;
        }

        .security-notice strong {
            color: #856404;
        }
    </style>

</body>
</html>
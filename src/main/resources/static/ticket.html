<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Management - Table View</title>
    <link rel="stylesheet" href="/css/table-style.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>Virspacio Ticket Management</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshTable()">Refresh</button>
                <button class="btn btn-success" onclick="bulkAction()">Bulk Action</button>
                <button class="btn btn-info" onclick="openUserManagement()" style="margin-left: 10px;">
                    Manage Users
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="content-wrapper">
            <!-- Sidebar Checklist -->
            <aside class="checklist-sidebar">
                <div class="sidebar-header">
                    <h3>Filters & Selection</h3>
                </div>

                <div class="quick-actions">
                    <h4>Quick Actions</h4>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="location.href='/dashboard'">
                            Dashboard
                        </button>
                        <button class="btn btn-success" onclick="location.href='/?create=new'">
                            Create New Ticket
                        </button>
                        <button class="btn btn-outline" onclick="exportData()">
                            Export to CSV
                        </button>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="bulk-actions">
                    <h4>Selected Tickets (<span id="selected-count">0</span>)</h4>
                    <button class="btn btn-small" onclick="selectAll()">Select All</button>
                    <button class="btn btn-small" onclick="clearSelection()">Clear</button>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                    <h4>Status</h4>
                    <label class="checkbox-item">
                        <input type="checkbox" value="OPEN" checked onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Open
                        <span class="count-badge" id="count-OPEN">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="IN_PROGRESS" checked onchange="updateFilters()">
                        <span class="checkmark"></span>
                        In Progress
                        <span class="count-badge" id="count-IN_PROGRESS">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="RESOLVED" onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Resolved
                        <span class="count-badge" id="count-RESOLVED">0</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" value="CLOSED" onchange="updateFilters()">
                        <span class="checkmark"></span>
                        Closed
                        <span class="count-badge" id="count-CLOSED">0</span>
                    </label>
                </div>

                <!-- Quick Stats -->
                <div class="stats-group">
                    <h4>Quick Stats</h4>
                    <div class="stat-item">
                        <span>Total Tickets:</span>
                        <strong id="stat-total">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Open:</span>
                        <strong id="stat-open">0</strong>
                    </div>
                    <div class="stat-item">
                        <span>Due Today:</span>
                        <strong id="stat-due-today">0</strong>
                    </div>
                </div>
            </aside>

            <!-- Main Table Area -->
            <main class="table-container">
                <!-- Table Controls -->
                <div class="table-controls">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search tickets..." 
                               onkeyup="debouncedSearch()">
                        <span class="search-icon">⌕</span>
                    </div>
                    
                    <div class="view-options">
                        <select id="sort-select" onchange="updateSorting()">
                            <option value="createdAt,desc">Newest First</option>
                            <option value="createdAt,asc">Oldest First</option>
                            <option value="priority,desc">Priority (High to Low)</option>
                            <option value="priority,asc">Priority (Low to High)</option>
                            <option value="title,asc">Title (A-Z)</option>
                        </select>
                        
                        <select id="page-size" onchange="changePageSize()">
                            <option value="10">10 per page</option>
                            <option value="25" selected>25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="auto-refresh-toggle">
                            <input type="checkbox" id="auto-refresh-toggle" checked>
                            <span class="toggle-slider"></span>
                            Live Updates
                        </label>
                        <span id="refresh-indicator" class="refresh-indicator"> Live</span>
                    </div>
                </div>

                <!-- Tickets Table -->
                <div class="table-wrapper">
                    <table class="tickets-table">
                        <thead>
                            <tr>
                                <th class="select-column">
                                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                                </th>
                                <th class="id-column">ID</th>
                                <th class="title-column">Title</th>
                                <th class="status-column">Status</th>
                                <th class="priority-column">Priority</th>
                                <th class="assignee-column">Assignee</th>
                                <th class="date-column">Created</th>
                                <th class="actions-column">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="loading-state hidden">
                    <div class="loading-spinner"></div>
                    <span>Loading tickets...</span>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state hidden">
                    <p>No tickets found matching your criteria.</p>
                    <button class="btn btn-primary" onclick="clearFilters()">Clear Filters</button>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing <span id="page-start">0</span> to <span id="page-end">0</span> 
                        of <span id="total-items">0</span> tickets
                    </div>
                    
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="first-page" onclick="goToPage(1)" disabled>
                            « First
                        </button>
                        <button class="pagination-btn" id="prev-page" onclick="previousPage()" disabled>
                            ‹ Previous
                        </button>
                        
                        <div class="page-numbers" id="page-numbers">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        
                        <button class="pagination-btn" id="next-page" onclick="nextPage()" disabled>
                            Next ›
                        </button>
                        <button class="pagination-btn" id="last-page" onclick="goToPage(1)" disabled>
                            Last »
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit Ticket Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Ticket</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label class="required">Subject</label>
                        <input type="text" class="form-input" id="edit-subject" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Status</label>
                        <select class="form-select" id="edit-status" required>
                            <option value="OPEN">Open</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="RESOLVED">Resolved</option>
                            <option value="CLOSED">Closed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Priority</label>
                        <select class="form-select" id="edit-priority" required>
                            <option value="LOW">Low</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Assigned To</label>
                        <select class="form-select" id="edit-assignedPerson" required>
                            <option value="">Select IT Staff</option>
                            <option value="IT Network and System Engineer">IT Network and System Engineer</option>
                            <option value="IT Support Specialist">IT Support Specialist</option>
                            <option value="IT Administrator">IT Administrator</option>
                            <option value="IT Manager">IT Manager</option>
                            <option value="System Analyst">System Analyst</option>
                            <option value="Database Administrator">Database Administrator</option>
                            <option value="Security Specialist">Security Specialist</option>
                        </select>
                    </div>
                    
                    <!-- Original Description (Read-only) -->
                    <div class="form-group">
                        <label>Original Description</label>
                        <div class="readonly-description" id="edit-original-description" style="
                            background: #f8f9fa;
                            padding: 12px;
                            border-radius: 4px;
                            border: 1px solid #e9ecef;
                            min-height: 80px;
                            max-height: 150px;
                            overflow-y: auto;
                            font-size: 0.9em;
                            color: #495057;
                        "></div>
                    </div>
                    
                    <!-- IT Comments Section -->
                    <div class="form-group">
                        <label>IT Comments & Updates</label>
                        <textarea class="form-textarea" id="edit-it-comment" placeholder="Add IT comments, updates, or resolution details here..." style="min-height: 100px;"></textarea>
                        <small style="color: #666; display: block; margin-top: 4px;">
                            This field is for IT staff comments only. The original description cannot be modified.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTicketEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- View Ticket Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ticket Details</h2>
                <span class="close" onclick="closeViewModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="ticket-details">
                    <div class="detail-row">
                        <label>Ticket ID:</label>
                        <span id="view-id"></span>
                    </div>
                    <div class="detail-row">
                        <label>Subject:</label>
                        <span id="view-subject"></span>
                    </div>
                    <div class="detail-row">
                        <label>Requester:</label>
                        <span id="view-requester"></span>
                    </div>
                    <div class="detail-row">
                        <label>Status:</label>
                        <span id="view-status"></span>
                    </div>
                    <div class="detail-row">
                        <label>Priority:</label>
                        <span id="view-priority"></span>
                    </div>
                    <div class="detail-row">
                        <label>Assigned To:</label>
                        <span id="view-assigned"></span>
                    </div>
                    <div class="detail-row">
                        <label>Created:</label>
                        <span id="view-created"></span>
                    </div>
                    
                    <!-- Network Information Section -->
                    <div class="detail-row full-width">
                        <label>Network Information:</label>
                        <div class="network-info-section">
                            <div class="network-info-item">
                                <span class="network-info-label">IP Address:</span>
                                <span id="view-ip">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Computer Name:</span>
                                <span id="view-computer">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">User Agent:</span>
                                <span id="view-useragent">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Private IP:</span>
                                <span id="view-private-ip">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Username:</span>
                                <span id="view-username">Unknown</span>
                            </div>
                            <div class="network-info-item">
                                <span class="network-info-label">Device ID:</span>
                                <span id="view-device-id">Unknown</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Original Description -->
                    <div class="detail-row full-width">
                        <label>Original Description:</label>
                        <div id="view-description" class="description-content"></div>
                    </div>
                    
                    <!-- IT Comments Section -->
                    <div class="detail-row full-width">
                        <label>IT Comments & Updates:</label>
                        <div id="view-it-comment" class="description-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Bulk Actions</h2>
                <span class="close" onclick="closeBulkModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Action</label>
                    <select class="form-select" id="bulk-action">
                        <option value="">Select Action</option>
                        <option value="assign">Assign Tickets</option>
                        <option value="change-status">Change Status</option>
                        <option value="change-priority">Change Priority</option>
                        <option value="close">Close Tickets</option>
                        <option value="delete">Delete Tickets</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-assign-field" style="display: none;">
                    <label>Assign To</label>
                    <select class="form-select" id="bulk-assignee">
                        <option value="">Select IT Staff</option>
                        <option value="IT Network and System Engineer">IT Network and System Engineer</option>
                        <option value="IT Support Specialist">IT Support Specialist</option>
                        <option value="IT Administrator">IT Administrator</option>
                        <option value="IT Manager">IT Manager</option>
                        <option value="System Analyst">System Analyst</option>
                        <option value="Database Administrator">Database Administrator</option>
                        <option value="Security Specialist">Security Specialist</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-status-field" style="display: none;">
                    <label>New Status</label>
                    <select class="form-select" id="bulk-status">
                        <option value="OPEN">Open</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="RESOLVED">Resolved</option>
                        <option value="CLOSED">Closed</option>
                    </select>
                </div>
                
                <div class="form-group" id="bulk-priority-field" style="display: none;">
                    <label>New Priority</label>
                    <select class="form-select" id="bulk-priority">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                
                <div class="selected-info">
                    <p>This action will affect <strong id="bulk-count">0</strong> selected tickets.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Apply Action</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="delete-confirm-message">Are you sure you want to delete this ticket? This action cannot be undone.</p>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDelete()">Delete Ticket</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="notification-header">
                <h2 id="notification-title">Notification</h2>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="notification-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeNotificationModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>User Management</h2>
                <span class="close" onclick="closeUserManagement()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- User Management Controls -->
                <div class="user-management-controls">
                    <div class="search-box">
                        <input type="text" id="userSearchInput" placeholder="Search users...">
                        <span class="search-icon">⌕</span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            + Add New User
                        </button>
                        <button class="btn btn-outline" onclick="exportUsersToCSV()">
                            Export CSV
                        </button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="table-wrapper">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Position</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserManagement()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Add New User</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" class="form-input" id="userFullName" required>
                    </div>

                    <div class="form-group">
                        <label class="required">Email</label>
                        <input type="email" class="form-input" id="userEmail" required>
                    </div>

                    <div class="form-group">
                        <label>Position</label>
                        <input type="text" class="form-input" id="userPosition" 
                               placeholder="e.g., Software Developer, HR Manager">
                    </div>

                    <div class="form-group">
                        <label class="required">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="USER">User</option>
                            <option value="ADMIN">Admin</option>
                            <option value="SUPER_ADMIN">Super Admin</option>
                        </select>
                    </div>

                    <div class="form-group" id="userPasswordGroup">
                        <label class="required">Password</label>
                        <input type="password" class="form-input" id="userPassword" 
                               placeholder="Enter password for new user">
                        <small style="color: #666;">
                            Password is required for new users. Leave blank when editing if you don't want to change it.
                        </small>
                    </div>

                    <!-- Admin-specific fields -->
                    <div id="adminFields" style="display: none;">
                        <div class="form-section">
                            <h3 class="form-section-title">Admin Settings</h3>
                            <div class="form-group">
                                <label>Admin Notes</label>
                                <textarea class="form-textarea" id="adminNotes" 
                                          placeholder="Additional notes for admin users..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Loading State -->
                <div id="userLoading" class="create-loading hidden">
                    <div class="loading-spinner"></div>
                    <p>Saving user...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="userSubmitBtn" onclick="saveUser()">
                    Add User
                </button>
            </div>
        </div>
    </div>

    <!-- Network Info Label (for forms) -->
    <div id="network-info-label" style="margin: 10px 0;"></div>

    <!-- JavaScript Modules -->
    <script src="/js/config.js"></script>
    <script src="/js/network-service.js"></script>
    <script src="/js/audio-service.js"></script>
    <script src="/js/ticket-service.js"></script>
    <script src="/js/modal-manager.js"></script>
    <script src="/js/bulk-action-manager.js"></script>
    <script src="/js/selection-manager.js"></script>
    <script src="/js/filter-manager.js"></script>
    <script src="/js/refresh-manager.js"></script>
    <script src="/js/user-manager.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>